import{initMasonry}from"./plugins/masonry.js";import{navbarShrink}from"./layouts/navbarShrink.js";export function initUtils(){Global.utils={html_root_dom:document.querySelector("html"),pageContainer_dom:document.querySelector(".page-container"),pageTop_dom:document.querySelector(".main-content-header"),homeBanner_dom:document.querySelector(".home-banner-container"),scrollProgressBar_dom:document.querySelector(".scroll-progress-bar"),pjaxProgressBar_dom:document.querySelector(".pjax-progress-bar"),pjaxProgressIcon_dom:document.querySelector(".swup-progress-icon"),backToTopButton_dom:document.querySelector(".tool-scroll-to-top"),toolsList:document.querySelector(".hidden-tools-list"),toggleButton:document.querySelector(".toggle-tools-list"),innerHeight:window.innerHeight,pjaxProgressBarTimer:null,prevScrollValue:0,fontSizeLevel:0,isHasScrollProgressBar:!0===Global.theme_config.global.scroll_progress.bar,isHasScrollPercent:!0===Global.theme_config.global.scroll_progress.percentage,updateScrollStyle(){const e=window.pageYOffset||document.documentElement.scrollTop,t=document.documentElement.scrollHeight,o=window.innerHeight||document.documentElement.clientHeight,n=this.calculatePercentage(e,t,o);this.updateScrollProgressBar(n),this.updateScrollPercent(n),this.updatePageTopVisibility(e,o),this.prevScrollValue=e},updateScrollProgressBar(e){if(this.isHasScrollProgressBar){const t=e.toFixed(3),o=0===e?"hidden":"visible";this.scrollProgressBar_dom.style.visibility=o,this.scrollProgressBar_dom.style.width=`${t}%`}},updateScrollPercent(e){if(this.isHasScrollPercent){const t=this.backToTopButton_dom.querySelector(".percent"),o=0!==e&&void 0!==e;this.backToTopButton_dom.classList.toggle("show",o),t.innerHTML=e.toFixed(0)}},updatePageTopVisibility(e,t){if(Global.theme_config.navbar.auto_hide){const o=this.prevScrollValue,n=o>t&&e>o;this.pageTop_dom.classList.toggle("hide",n)}else this.pageTop_dom.classList.remove("hide")},calculatePercentage:(e,t,o)=>Math.round(e/(t-o)*100),registerWindowScroll(){window.addEventListener("scroll",()=>{this.updateScrollStyle(),this.updateTOCScroll(),this.updateNavbarShrink(),this.updateHomeBannerBlur(),this.updateAutoHideTools(),this.updateAPlayerAutoHide()})},updateTOCScroll(){Global.theme_config.articles.toc.enable&&Global.utils.hasOwnProperty("updateActiveTOCLink")&&Global.utils.updateActiveTOCLink()},updateNavbarShrink(){navbarShrink.init()},updateHomeBannerBlur(){if("fixed"===Global.theme_config.home_banner.style&&location.pathname===Global.hexo_config.root){const e=document.querySelector(".home-banner-background"),t=window.innerHeight,o=(window.scrollY||window.pageYOffset)>=t/2?15:0;try{e.style.transition="0.3s",e.style.webkitFilter=`blur(${o}px)`}catch(e){}}},updateAutoHideTools(){const e=window.pageYOffset,t=document.body.scrollHeight,o=window.innerHeight,n=document.getElementsByClassName("right-side-tools-container");for(let l=0;l<n.length;l++){const a=n[l];e<=0?"/"!==location.pathname||a.classList.add("hide"):e+o>=t-20?a.classList.add("hide"):a.classList.remove("hide")}},updateAPlayerAutoHide(){const e=document.getElementById("aplayer");if(null==e);else{const t=window.pageYOffset,o=document.body.scrollHeight,n=window.innerHeight;t<=0?"/"!==location.pathname||e.classList.add("hide"):t+n>=o-20?e.classList.add("hide"):e.classList.remove("hide")}},toggleToolsList(){this.toggleButton.addEventListener("click",()=>{this.toolsList.classList.toggle("show")})},globalFontSizeAdjust(){const e=this.html_root_dom,t=document.querySelector(".tool-font-adjust-plus"),o=document.querySelector(".tool-font-adjust-minus"),n=document.defaultView.getComputedStyle(document.body).fontSize,l=parseFloat(n);let a=0;const i=Global.getStyleStatus();function s(t){const o=l*(1+.05*t);e.style.fontSize=`${o}px`,Global.styleStatus.fontSizeLevel=t,Global.setStyleStatus()}i&&s(a=i.fontSizeLevel),t.addEventListener("click",function(){s(a=Math.min(a+1,5))}),o.addEventListener("click",function(){s(a=Math.max(a-1,0))})},contentAreaWidthAdjust(){const e=document.querySelector(".tool-expand-width"),t=document.querySelector(".navbar-content"),o=document.querySelector(".main-content"),n=e.querySelector("i"),l=Global.theme_config.global.content_max_width||"1000px";let a=l,i=!1;!0===Global.theme_config.home_banner.enable&&"/"===window.location.pathname&&(a=1.2*parseInt(l)+"px");const s=e=>{Global.styleStatus.isExpandPageWidth=e,Global.setStyleStatus(),e?(n.classList.remove("fa-expand"),n.classList.add("fa-compress"),t.style.maxWidth="90%",o.style.maxWidth="90%"):(n.classList.remove("fa-compress"),n.classList.add("fa-expand"),t.style.maxWidth=a,o.style.maxWidth=l)};(()=>{const e=Global.getStyleStatus();e&&(i=e.isExpandPageWidth,s(i))})(),e.addEventListener("click",()=>{s(i=!i);var e=document.querySelector(".loading-placeholder"),t=document.querySelector("#masonry-container");e&&t&&(e.style.opacity=1,e.style.display="block",t.style.display="none",setTimeout(()=>{initMasonry()},300))})},goComment(){this.goComment_dom=document.querySelector(".go-comment"),this.goComment_dom&&this.goComment_dom.addEventListener("click",()=>{const e=document.querySelector("#comment-anchor");if(e){const t=e.getBoundingClientRect().top+window.scrollY;window.scrollTo({top:t,behavior:"smooth"})}})},getElementHeight(e){const t=document.querySelector(e);return t?t.getBoundingClientRect().height:0},inithomeBannerHeight(){this.homeBanner_dom&&(this.homeBanner_dom.style.height=this.innerHeight+"px")},initPageHeightHandle(){if(this.homeBanner_dom)return;const e=this.getElementHeight(".main-content-header")+this.getElementHeight(".main-content-body")+this.getElementHeight(".main-content-footer"),t=window.innerHeight,o=document.querySelector(".main-content-footer");if(e<t){const n=Math.floor(t-e);n>0&&(o.style.marginTop=`${n-2}px`)}},imageViewer(){let e=!1,t=1,o=!1,n=0,l=0,a=0,i=0;const s=document.querySelector(".image-viewer-container"),r=s.querySelector("img"),c=e=>{document.body.style.overflow=e?"hidden":"auto",e?s.classList.add("active"):s.classList.remove("active")};let d=0;const m=e=>{o&&e.stopPropagation(),o=!1};r.addEventListener("wheel",e=>{e.preventDefault();const o=r.getBoundingClientRect(),n=e.clientX-o.left,l=e.clientY-o.top,s=n-o.width/2,c=l-o.height/2,d=t;t+=-.001*e.deltaY,d<(t=Math.min(Math.max(.8,t),4))?(a-=s*(t-d),i-=c*(t-d)):(a=0,i=0),r.style.transform=`translate(${a}px, ${i}px) scale(${t})`}),r.addEventListener("mousedown",e=>{e.preventDefault(),o=!0,n=e.clientX,l=e.clientY}),r.addEventListener("mousemove",e=>{if(o){const o=(new Date).getTime();if(o-d<100)return;d=o;const s=e.clientX-n,c=e.clientY-l;a+=s,i+=c,n=e.clientX,l=e.clientY,r.style.transform=`translate(${a}px, ${i}px) scale(${t})`}}),r.addEventListener("mouseup",m),r.addEventListener("mouseleave",m),s.addEventListener("click",o=>{o.target===o.currentTarget&&(c(e=!1),t=1,a=0,i=0,r.style.transform=`translate(${a}px, ${i}px) scale(${t})`)});const u=document.querySelectorAll(".markdown-body img, .masonry-item img, #shuoshuo-content img"),g=o=>{"Escape"===o.key&&e&&(c(e=!1),t=1,a=0,i=0,r.style.transform=`translate(${a}px, ${i}px) scale(${t})`,document.removeEventListener("keydown",g))};u.forEach(t=>{t.addEventListener("click",()=>{c(e=!0),r.src=t.src,document.addEventListener("keydown",g)})}),!u.length&&s&&s.parentNode.removeChild(s)},setHowLongAgoLanguage:(e,t)=>t.replace(/%s/g,e),getHowLongAgo(e){const t=Global.language_ago,o=Math.floor(e/2592e3/12),n=Math.floor(e/2592e3),l=Math.floor(e/86400/7),a=Math.floor(e/86400),i=Math.floor(e/3600%24),s=Math.floor(e/60%60),r=Math.floor(e%60);return o>0?this.setHowLongAgoLanguage(o,t.year):n>0?this.setHowLongAgoLanguage(n,t.month):l>0?this.setHowLongAgoLanguage(l,t.week):a>0?this.setHowLongAgoLanguage(a,t.day):i>0?this.setHowLongAgoLanguage(i,t.hour):s>0?this.setHowLongAgoLanguage(s,t.minute):r>0?this.setHowLongAgoLanguage(r,t.second):void 0},relativeTimeInHome(){const e=document.querySelectorAll(".home-article-meta-info .home-article-date"),t=Global.theme_config.home.article_date_format;"relative"===t?e&&e.forEach(e=>{const t=Date.now(),o=new Date(e.dataset.date.split(" GMT")[0]).getTime();e.innerHTML=this.getHowLongAgo(Math.floor((t-o)/1e3))}):"auto"===t&&e&&e.forEach(e=>{const t=Date.now(),o=new Date(e.dataset.date.split(" GMT")[0]).getTime();Math.floor((t-o)/864e5)<7&&(e.innerHTML=this.getHowLongAgo(Math.floor((t-o)/1e3)))})}},Global.utils.registerWindowScroll(),Global.utils.toggleToolsList(),Global.utils.globalFontSizeAdjust(),Global.utils.contentAreaWidthAdjust(),Global.utils.goComment(),Global.utils.initPageHeightHandle(),Global.utils.inithomeBannerHeight(),Global.utils.imageViewer(),Global.utils.relativeTimeInHome()};